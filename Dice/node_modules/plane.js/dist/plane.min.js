(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):a.plane=b()})(this,function(){'use strict';function a(a){const b=` ${P.join(' ')} `;return 0<=b.indexOf(` ${a} `)}function b(a){return /[0-9]/i.test(a)}function c(a){return /[a-z]/i.test(a)}function d(a){return c(a)||0<=T.join('').indexOf(a)}function e(a){return 0<=Q.join('').indexOf(a)}function f(a){return 0<=R.join('').indexOf(a)}function g(a){return 0<=S.join('').indexOf(a)}function h(a,b,c=''){if(!a.eof()&&b(a.peek())){const d=c+a.next();return h(a,b,d)}return c}function i(a){let c=!1;const d=h(a,(a)=>{return'.'===a?!c&&(c=!0,!0):b(a)});return{type:'num',value:parseFloat(d)}}function j(b){const c=h(b,d),e=a(c)?'keyword':'const';return{type:e,value:c}}function k(a,b,c='',d=[],e=[]){let f=!1;for(a.next();!a.eof();){const g=a.next();if(U(a)){e.push({type:'str',value:c+g}),a.next(),a.next();const b=j(a);return d.push(b),k(a,'"','',d,e)}if(f)c+=g,f=!1;else if('\\'===g)f=!0;else if(g===b)break;else c+=g}return 0<d.length||0<e.length?(e.push({type:'str',value:c}),{expressions:d,quasis:e}):c}function l(a){const b=k(a,'"'),c='string'==typeof b?'str':'template';return{type:c,value:b}}function m(a){h(a,(a)=>'\n'!==a),a.next()}function n(a){if(h(a,g),a.eof())return null;const d=a.peek();return'#'===d?(m(a),n(a)):'"'===d?l(a):b(d)?i(a):c(d)?j(a):f(d)?{type:'punc',value:a.next()}:e(d)?{type:'op',value:h(a,e)}:a.fail(`Unable to process character: ${d}`)}function o(a){function b(){return c||(c=n(a))}let c=null;return{next:function(){const b=c;return c=null,b||n(a)},peek:b,eof:function(){return null===b()},fail:a.fail}}function p(a,b){const c=a.peek();return c&&'punc'===c.type&&(!b||c.value===b)&&c}function q(a,b){const c=a.peek();return c&&'keyword'===c.type&&(!b||c.value===b)&&c}function r(a,b){const c=a.peek();return c&&'op'===c.type&&(!b||c.value===b)&&c}function s(a,b){p(a,b)?a.next():a.fail(`Expecting punctuation: ${b}`)}function t(a,b){q(a,b)?a.next():a.fail(`Expecting keyword: "${b}"`)}function u(a){a.fail(`Unexpected token: ${JSON.stringify(a.peek())}`)}function v(b,c,d,e,f){const g=[];let a=!0;for(s(b,c);!b.eof()&&!p(b,d)&&(a?a=!1:s(b,e),!p(b,d));)g.push(f(b));return s(b,d),g}function w(a){const b=a.next();return'const'!==b.type&&a.fail('Expecting constant name'),b.value}function x(a,b){const c=v(a,'(',')',',',H);return{type:'call',func:b,args:c}}function y(a){const b='true'===a.next().value;return{type:'bool',value:b}}function z(a,b){const c=b();return p(a,'(')?x(a,c):c}function A(a){const b=v(a,'(',')',',',w),c=H(a);return{type:'fn',constants:b,body:c}}function B(a){t(a,'if');const b=H(a),c=H(a),d={type:'if',condition:b,then:c};return q(a,'else')?(a.next(),Object.assign({},d,{else:H(a)})):d}function C(a){const b=v(a,'{','}',';',H);return 0===b.length?W:1===b.length?b[0]:{type:'prog',prog:b}}function D(a){const{expressions:b,quasis:c}=a.value;return{type:'string-template',expressions:b,quasis:c}}function E(a,b){return b(a,()=>{if(p(a,'(')){a.next();const b=H(a);return s(a,')'),b}if(p(a,'{'))return C(a);if(q(a,'if'))return B(a);if(q(a,'true')||q(a,'false'))return y(a);if(q(a,'fn'))return a.next(),A(a);const b=a.next();return'template'===b.type?D(b):'const'===b.type||'num'===b.type||'str'===b.type?b:u(a)})}function F(a,b,c){const d=r(a);if(d){const e=V[d.value];if(e>c){a.next();const f='='===d.value?'assign':'binary',g=F(a,E(a,z),e);return F(a,{type:f,left:b,operator:d.value,right:g},c)}}return b}function G(a,b){if(a.eof())return b;const c=b.concat([H(a)]);return s(a,';'),G(a,c)}function H(a){return z(a,()=>F(a,E(a,z),0))}function I(a,b=G){const c=b(a,[]);return{type:'prog',prog:c}}function J(a,b){return b in a.constants?a:'undefined'!=typeof a.parent&&J(a.parent,b)}function K(a,b,c){switch(a){case'+':return Z(b)+Z(c);case'-':return Z(b)-Z(c);case'*':return Z(b)*Z(c);case'/':return Z(b)/$(c);case'%':return Z(b)%$(c);case'**':return Z(b)**Z(c);case'&&':return!1!==b&&c;case'||':return!1===b?c:b;case'<':return Z(b)<Z(c);case'>':return Z(b)>Z(c);case'<=':return Z(b)<=Z(c);case'>=':return Z(b)>=Z(c);case'==':return b===c;case'!=':return b!==c;case'|>':return c(b);default:throw new Error(`Unable to process operator ${a}`);}}function L(a,b,c){const d=b.constants,e=a.extend();return function(...a){let f=0;return d.forEach((b)=>{e.set(b,!!(f<a.length)&&a[f]),f+=1}),c(b.body,e)}}function M(a,b,c,d){return c.map((c,e)=>{const f='undefined'==typeof b[e]?'':d(b[e],a);return c.value+f}).join('')}function N(a,b){switch(a.type){case'num':case'str':case'bool':return a.value;case'const':return b.get(a.value);case'assign':{if('const'!==a.left.type)throw new Error(`Cannot assign to ${JSON.stringify(a.left)}`);return b.set(a.left.value,N(a.right,b))}case'binary':{const c=N(a.left,b),d=N(a.right,b);return K(a.operator,c,d)}case'string-template':{const{expressions:c,quasis:d}=a;return M(b,c,d,N)}case'fn':return L(b,a,N);case'if':{const c=N(a.condition,b);return!1===c?!!a.else&&N(a.else,b):N(a.then,b)}case'prog':{let c=!1;return a.prog.forEach((a)=>{c=N(a,b)}),c}case'call':{const c=N(a.func,b);return c(...a.args.map((a)=>N(a,b)))}default:throw new Error(`Unable to process expression: ${a.type}`);}}var O=function(a){let b=0,c=1,d=0;const e=()=>a.charAt(b);return{next:()=>{const e=a.charAt(b);return b+=1,'\n'===e?(c+=1,d=0):d+=1,e},lookAhead:()=>{const c=a.charAt(b+1);return c},peek:e,eof:()=>''===e(),fail:(a)=>{throw new Error(`${a} (${c}:${d})`)}}};const P=['if','else','fn','true','false'],Q=['+','-','*','/','%','=','&','|','<','>','!'],R=['',',',';','(',')','{','}','[',']','','$'],S=[' ','\t','\n'],T=['?','!','-','<','>','=','0','1','2','3','4','5','6','7','8','9'],U=(a)=>'$'===a.peek()&&'{'===a.lookAhead(),V={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"|>":8,"+":10,"-":10,"*":20,"/":20,"%":20,"**":30},W={type:'bool',value:!1};var X=function(a){a.set('log',(a)=>console.log(a))};class Y{constructor(a){this.constants=Object.create(null),this.parent=a,X(this)}extend(){const a=new Y(this);return a}lookup(a){const b=J(this,a);return b}get(a){const b=this.lookup(a);if(!1!==b)return b.constants[a];throw new Error(`Undefined constant: "${a}"`)}set(a,b){if(this.constants[a])throw new Error(`Attempting to reassign constant: "${a}"`);return this.constants[a]=b,this}}const Z=(a)=>{if('number'!=typeof a)throw new Error(`Expected number but got: "${a}"`);return a},$=(a)=>{if(0===Z(a))throw new Error('Unable to divide number by zero');return a},_=new Y;return function(a){const b=O(a),c=o(b),d=I(c);N(d,_)}});
